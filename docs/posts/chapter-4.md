---
title: skipList å®ç°
author: æ–°è‡ªåŠ©
date: '2022-02-17'
---

> æœ¬ç¯‡é‡ç‚¹å…³æ³¨ä»¥ä¸‹ 2 ç‚¹ï¼š
> 1. skipList çš„å®ç°
> 2. redis ä¸­å¯¹äº skipList çš„æ‰©å±•

âš ï¸ æœ¬ç¯‡å±äºçº¯çº¯çš„æ•°æ®ç»“æ„ï¼Œå¦‚æœä½ å¯¹æ•°æ®ç»“æ„æ„Ÿåˆ°ææƒ§å¯ä»¥è·³è¿‡æœ¬ç¯‡ï¼Œç›´æ¥ä½¿ç”¨ GitHub ä¸Šçš„ä»£ç ï¼Œä¸ä¼šå¯¹åç»­çš„å­¦ä¹ äº§ç”Ÿå½±å“ã€‚*ä¸è¿‡æˆ‘è¿˜æ˜¯å»ºè®®ä½ ç›´é¢ææƒ§ğŸ˜ƒ*ã€‚

## ğŸ‘¨â€ğŸ« skiplist ä»‹ç»

redis ä¸­ sortedset çš„åº•å±‚æ•°æ®ç»“æ„å°±æ˜¯ä½¿ç”¨ skiplistï¼Œæ‰€ä»¥åœ¨å®ç° sortedset ç›¸å…³å‘½ä»¤ä¹‹å‰ï¼Œæˆ‘ä»¬æœ‰å¿…è¦äº†è§£å¹¶ä¸”å®ç° skiplistã€‚

skiplist çš„ç›®çš„æ˜¯ä¸ºäº†å¿«é€ŸæŸ¥æ‰¾ï¼Œå®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªã€Œæœ‰åºé“¾è¡¨ã€ï¼Œä½†æ˜¯ä¸ºäº†æ›´å¿«çš„æŸ¥æ‰¾ï¼Œåœ¨æœ‰åºé“¾è¡¨ä¸Šåšäº†ä¸€äº›æ”¹è¿›ã€‚ä¸‹é¢ç”¨å‡ å¼ å›¾ç¤ºæ¥å±•ç¤º skiplist å·¥ä½œåŸç†ã€‚

å¯¹äºä¸€ä¸ªæœ‰åºé“¾è¡¨ï¼šæŸ¥æ‰¾æ•ˆç‡æ˜¯ `O(n)`ï¼ŒåŒæ ·å¯¹æœ‰åºé“¾è¡¨çš„å¢åˆ æ”¹éƒ½è¦å…ˆè¿›è¡ŒæŸ¥æ‰¾ï¼Œæ‰€ä»¥å¢åˆ æ”¹çš„æ•ˆç‡ä¹Ÿæ˜¯ `O(n)`ã€‚è¿™ä¸ªæ•ˆç‡æ˜¯æ¯”è¾ƒæ…¢çš„ï¼Œå®ƒçš„å¥½å¤„åœ¨äºå…ƒç´ å·²ç»æœ‰åºï¼Œè¿™æ ·å¯¹ `zrank` ä¹‹ç±»çš„å‘½ä»¤ç›´æ¥é¡ºåºè¯»å–é“¾è¡¨æ•°æ®å°±è¡Œã€‚

![](https://raw.githubusercontent.com/chenjiayao/sidergo-posts/master/docs/images/20220402093329.png)

åœ¨ä»£ç ä¸­ï¼Œé€šå¸¸ä¼šè¿™ä¹ˆè®¾è®¡æœ‰åºé“¾è¡¨

```golang
type Node struct {
    Element     //ä¿å­˜å…ƒç´ 
    backward *Node //å‰ä¸€ä¸ªèŠ‚ç‚¹
    forward *Node //ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
}
```

å¦‚æœï¼Œæˆ‘ä»¬è¦æé«˜æœ‰åºé“¾è¡¨çš„æŸ¥æ‰¾æ•ˆç‡ï¼Œ**å–é—´éš”èŠ‚ç‚¹ï¼Œå¯¹èŠ‚ç‚¹æ–°å¢ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ä¸‹ä¸‹ä¸ªèŠ‚ç‚¹**ï¼š

![](https://raw.githubusercontent.com/chenjiayao/sidergo-posts/master/docs/images/20220402103927.png)


è¿™æ ·æœ‰åºé“¾è¡¨å°±è¿›åŒ–äº†ï¼Œç°åœ¨å‡è®¾æˆ‘ä»¬è¦æŸ¥æ‰¾ 19ï¼ŒæŸ¥æ‰¾æ€è·¯å¦‚ä¸‹ï¼š

1. ä» 3 çš„ä¸¤ä¸ª forward æŒ‡é’ˆéå†ï¼Œç¬¬ä¸€ä¸ª foward æŒ‡å‘çš„ä¸‹ä¸€ä¸ªå…ƒç´ çš„å€¼ä¸º 12ï¼Œ12 < 19ï¼Œé‚£ä¹ˆ 12 ä¹‹å‰çš„èŠ‚ç‚¹éƒ½å°±ä¸ç”¨éå†äº†ã€‚åœ¨ä¸Šé¢çš„å›¾ç¤ºä¸­ï¼ŒèŠ‚ç‚¹ 8 åœ¨æŸ¥æ‰¾è¿‡ç¨‹ä¸­å°±è¢«è·³è¿‡äº†ï¼Œè¿™ä¹Ÿæ˜¯ skiplist åå­—çš„ç”±æ¥ã€‚
2. åŒæ ·ï¼Œéå† 12 çš„ä¸¤ä¸ª forward æŒ‡é’ˆï¼Œç¬¬ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘çš„èŠ‚ç‚¹ä¸º 23ï¼Œ23 > 19ï¼Œé‚£ä¹ˆæ¥ç€æŸ¥çœ‹ç¬¬äºŒä¸ª forward æŒ‡é’ˆï¼Œç¬¬äºŒä¸ªæŒ‡é’ˆæŒ‡å‘ 19ï¼Œå°±æ˜¯æˆ‘ä»¬è¦æ‰¾çš„å…ƒç´ ã€‚


å’Œæœ‰åºåˆ—è¡¨å¯¹æ¯”æŸ¥æ‰¾æ•ˆç‡ï¼Œæœ‰åºåˆ—è¡¨éœ€è¦éå† `3-8-12-19`ï¼Œè€Œç°åœ¨åªè¦éå† `3-12-19`ï¼Œå¦‚æœé“¾è¡¨é•¿åº¦å¤Ÿé•¿ï¼Œé‚£ä¹ˆæ•ˆç‡æé«˜ä¼šæ›´æ˜æ˜¾ã€‚

è¿™ç§æƒ…å†µä¸‹ï¼ŒNode ç»“æ„ä½“å¯ä»¥è®¾è®¡æˆè¿™æ ·

```golang
type Node struct {
    Element
    forwards   []*Node //  ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œ
    backward *Node    //  æœ€åº•å±‚çš„å‰ä¸€ä¸ªèŠ‚ç‚¹
}
```

è¿™ç§å½¢æ€è·ç¦»çœŸæ­£çš„ skiplist å·²ç»å¾ˆæ¥è¿‘äº†ï¼ŒçœŸæ­£çš„ skiplist å¯¹äºå“ªäº›èŠ‚ç‚¹è¦å¢åŠ æŒ‡é’ˆæ˜¯éšæœºçš„ã€‚

![](https://raw.githubusercontent.com/chenjiayao/sidergo-posts/master/docs/images/20220402110046.png)

ä¸Šé¢çš„å›¾ç¤ºå°±æ˜¯ä¸€ä¸ª skiplistï¼Œå¯¹äºå“ªä¸ªèŠ‚ç‚¹éœ€è¦å¢åŠ æŒ‡é’ˆï¼Œå¢åŠ å¤šå°‘ä¸ªæŒ‡é’ˆæ˜¯éšæœºçš„ã€‚è¿™æ ·ï¼Œskiplist çš„æ—¶é—´å¤æ‚åº¦æ˜¯ `O(log n)`ï¼Œå’Œæ ‘çš„æ—¶é—´å¤æ‚åº¦ä¸€æ ·ï¼Œæ•ˆç‡å¾ˆé«˜ã€‚


## ğŸ‘¨â€ğŸ’» ä»£ç å®ç°

ç°åœ¨æˆ‘ä»¬å·²ç»çŸ¥é“ skiplist çš„å½¢æ€å’ŒæŸ¥æ‰¾æ€è·¯ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥å°è¯•å®ç°äº†ã€‚

é¦–å…ˆ Node çš„ç»“æ„ä½“ä¸Šé¢å·²ç»æåˆ°äº†

```golang

type Element struct {
	Score  float64
	Member string
}

type Level struct {
    forward *Node //åŒå±‚çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
}

type Node struct {
    Element
    forwards   []*Level //  ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œ
    backward *Node    //  æœ€åº•å±‚çš„å‰ä¸€ä¸ªèŠ‚ç‚¹
}
```

ä»¥èŠ‚ç‚¹ 8 ä¸ºä¾‹å­æ¥å±•ç¤ºä¸‹ Node å„ä¸ªå±æ€§æ‰€è¡¨ç¤ºçš„å«ä¹‰

![](https://raw.githubusercontent.com/chenjiayao/sidergo-posts/master/docs/images/20220402114625.png)

é™¤äº† Nodeï¼Œè¿˜éœ€è¦ä¸€ä¸ªç»“æ„ä½“æ¥è¡¨ç¤º skiplist

```golang
type SkipList struct {
    tail   *Node
    header *Node
    level  int    // æœ€é«˜ level å±‚æ•°ï¼Œä¸Šé¢å›¾ç¤ºä¸­ä¸º 4ï¼Œ(æœ€é«˜ä¸ºèŠ‚ç‚¹ 8ï¼Œæœ‰ 4 å±‚)
    length int64  // skiplist é•¿åº¦
}
```
ç°åœ¨ï¼ŒElementã€Node å’Œ SkipList ç»“æ„ä½“éƒ½æœ‰äº†ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•å®ç° skiplist çš„å¢åˆ æ”¹æŸ¥ï¼Œä¸è¿‡åœ¨æ­¤ä¹‹å‰éœ€è¦å®ç° `MakeSkipList` å’Œ `MakeNode` ä¸¤ä¸ªå‡½æ•°ã€‚


åˆ›å»ºä¸€ä¸ª Node éœ€è¦ 3 ä¸ªå±æ€§ï¼š
1. score
2. member
3. level

å‰ä¸¤ä¸ªä¸º redis zset éœ€è¦çš„ï¼Œç¬¬ä¸‰ä¸ª level å¯ä»¥è®¾å®šå½“å‰ Node çš„å±‚æ•°ã€‚æœ‰äº†è¿™ 3 ä¸ªå±æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å®ç° `MakeNode`

```golang
func MakeNode(level int, score float64, member string) *Node {

    node := &Node{
        Element: Element{
            Score:  score,
            Member: member,
        },
        levels: make([]*Level, level),
    }

    for i := 0; i < len(node.levels); i++ {
        node.levels[i] = &Level{
            forward: nil,
        }
    }
    return node
}
```


`MakeSkipList` ä¼šåˆ›å»ºä¸€ä¸ª skiplistï¼Œä¸ºäº†ä»£ç é€»è¾‘æ¯”è¾ƒæ¸…æ¥šï¼Œé€šå¸¸ä¼šä¸º skiplist åˆ›å»ºä¸€ä¸ª nodeï¼Œè¿™ä¸ª node ä¸ä¿å­˜ Elementï¼ŒæŠŠè¿™ä¸ªç©º Node å½“ä½œ skiplist çš„ headerã€‚

```golang
func MakeSkipList() *SkipList {
	return &SkipList{
		tail:   nil,
		header: MakeNode(MAX_LEVEL, 0, ""),
		level:  1,
		length: 0,
	}
}

```